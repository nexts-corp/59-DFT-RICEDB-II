
<link rel="import" href="./../components/panel-right/panel-right.html">
<link rel="import" href="./components/calculate-list.html">
<!--<link rel="import" href="./components/calculate-listQuota.html">-->

<dom-module id="page-calculate">
    <style is="custom-style" include="iron-flex iron-flex-factors iron-flex-alignment gl-size gl-color">
        * {
            font-family: 'rsuregular', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .header {
          padding: 10px 0px 10px 10px;
          background-color: var(--paper-grey-100);
          color: var(--paper-grey-600);
          font-size: var(--font-size-h4);
          font-family: 'rsuregular', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .registor{
          margin: 20px;
        }
        .title {
          text-align: center;
           font-size: var(--font-size-h3);
           font-family: 'rsuregular', sans-serif;
             -webkit-font-smoothing: antialiased;
        }
        .searchBox{
          padding: 5px;
          background-color: var(--gl-gray-lighter-color);
        }
        .elevation{
          border-radius: 5px;
          margin: 10px;
          padding: 5px;
        }
        .searchBorder{
          border: 1px solid var(--gl-gray-light-color);
          margin: 15px;
          border-radius: 3px;
        }
        paper-material {
          background-color: var(--gl-white-color);
        }
        gl-search-input{
          margin: 30px 0px 0px 0px;
        }


        .container{
          margin-left: 30px;
        }

        
        .fontContent{
          font-size: 20px;
          /*text-decoration: blink;*/
          padding: 15px;
          margin-top: 10px;
          text-align: center;
          margin-bottom: 10px;
          /*background-color: var(--gl-gray-lighter-color);*/
        }
        .font{
          font-family: 'CSChatThaiUI', sans-serif !important;
          -webkit-font-smoothing: antialiased;
        }
    </style>
    <template>
    <content-panel>
      <grid>
        <div class="layout vertical registor">
          <div class="flex">
            <div class="layout horizontal end-justified">
              <paper-button hidden="{{hide}}" raised class="gl-btn-primary"on-tap="_toggleDrawer" id="addRedRegExporter">ตั้งค่าการคำนวณโควตา</paper-button>
            </div>
          </div>
          <div class="flex title">
            การคำนวณส่วนจัดสรร
          </div>
          <div class="fontContent">
              การคำนวณส่วนจัดสรรข้าวภายใต้โควตาภาษีสหภาพยุโรป
          </div>
          <div class="container">
            <gl-form-dropdown-menu label="ปีโควตา">
              <paper-listbox class="dropdown-content" attr-for-selected="year" selected="{{selectQuotaYear}}">
                <template is="dom-repeat" items="{{getYear}}">
                  <paper-item class="font" year="{{item}}">{{item}}</paper-item>
                </template>
              </paper-listbox>
            </gl-form-dropdown-menu>
          </div>
          
          <div style="overflow-x:auto; padding:20px;">
            <calculate-list list-data="{{dataList}}" on-data-select="_onDataSelect"></calculate-list>
          </div>
        </div>
        <!-- </paper-material> -->

        <div class="layout horizontal end-justified" style="padding: 0px 20px 0px 0px">
          <!--<paper-button raised class="gl-btn-primary">ดำเนินการคำนวณโควตา</paper-button>-->
        </div>

      </grid>
      <panel-right title="การคำนวณส่วนจัดสรร" set-width="85%">
          <template is="dom-if" if="[[rendered]]">
            <iron-pages selected="{{pageSelect}}">
              <div><calculate-setting quota-year="{{sendQuotaYear}}" ordinal-number="{{dataList}}" on-post-sum="_postSumData" on-post-data="_postData" sum-answer="{{answerSum}}"></calculate-setting></div>
              <div><calculate-listQuota data="{{dataListQuota}}" on-save-data="_saveData" on-delete-data="_confirmData"></calculate-listQuota></div>
            </iron-pages>
          </template>
      </panel-right>
    </content-panel>
    </template>
    <script>
        Polymer({
            is: "page-calculate",
            observers:[
              '_yearQuoataChaged(selectQuotaYear)'
            ],
            properties: {
                layerContent: {
                    type: String,
                    value: "detailRegExporter"
                }
            },
            attached: function(){
              this._getYear();
              this.hide = true;
               Polymer.RenderStatus.afterNextRender(this,function(){
                this.importHref(this.resolveUrl('./components/calculate-setting.html'), (e)=>{
                    this.rendered = true;
                }, (e)=> {
                    console.log('error')
                });
                 this.importHref(this.resolveUrl('./components/calculate-listQuota.html'), (e)=>{
                    this.rendered = true;
                }, (e)=> {
                    console.log('error')
                });

              }); 
            },
            _toggleDrawer: function(e) {
              this.$$('panel-right')._setWidth('80%');
              this.$$("panel-right").toggle();
              this.pageSelect = 0;
              
            },
            _getYear:function(){
              axios.get('./eu/quota/year')
              .then((response)=>{
                console.log("success");
                this.getYear = response.data;
                //console.log(this.getYear);
              })
              .catch((error)=>{
                console.log("error");
                console.log(error.message);
                this.fire('toast',{status:'connectError',text:error.message,
                  callback:function(){
                    //console.log('test');
                  }})
              });
          },
          _yearQuoataChaged:function(quota){
            this.sendQuotaYear = quota;
            this.hide = false;
            this._getDatalist();
          },
          _postSumData:function(e){
              // console.log(e.detail);
              axios.post('/eu/calculate/calculate',e.detail)
              .then((response)=>{
              console.log("success");
              //this.textToast = 'บันทึกข้อมูลสำเร็จ';
              console.log(response.data);
              this.sumData = response.data;

              this.answerSum = {
                sum_export : response.data.sum_export,
                sum_for_cal : response.data.sum_for_cal,
                sum_quota : response.data.sum_quota,
                quota_amount : response.data.quota_amount
              }
              this.textToast = 'คำนวณสำเร็จ';
              this.fire('toast',{
                status:'success',
                text:this.textToast,
                callback:function(){
                //console.log('test');
                  
                }
              });
              console.log(this.answerSum);
              })
              .catch((error)=>{
                console.log("error");
                console.log(error);
            });
          },
          _postData:function(e){
            // console.log(e.detail);
            // http://localhost:3000/api/eu/calculate/allocate_quota
              this.fire('toast',{status:'load'});
              console.log(this.sumData);
              var sumData = Object.assign(this.sumData);
              sumData.quota_id = e.detail.quota_id;
              sumData.type_rice_id = e.detail.type_rice_id;
              sumData.ordinal_number = e.detail.ordinal_number;
              
              axios.post('/eu/calculate/allocate_quota',sumData)
              .then((response)=>{
              console.log("success");
              //this.textToast = 'บันทึกข้อมูลสำเร็จ';
              this.textToast = 'บันทึกข้อมูลสำเร็จ';
              this.fire('toast',{
                status:'success',
                text:this.textToast,
                callback:function(){
                //console.log('test');
                
                }
              });
              this.$$("panel-right").toggle();
              this._getDatalist();
              })
              .catch((error)=>{
                console.log("error");
                console.log(error);
            });
          },
          _getDatalist:function(){
              this.fire('toast',{status:'load'});
              axios.get('./eu/calculate/allocate_quota?quota_id='+this.sendQuotaYear )
              .then((response)=>{
                console.log("success!!");
                //this.fire('toast',{status:'loadSuccess'});
                this.fire('toast',{
                  status:'success',
                  text:this.textToast,
                  callback:function(){
                    //console.log('test');
                  }
                });
                this.dataList = response.data;
                if(this.dataList == ''){
                   this.pageSelect = 0;
                   this.$$("panel-right").toggle();
                }
                console.log('dataList',response.data);
              })
              .catch((error)=>{
                console.log("error");
                console.log(error);
                this.fire('toast',{status:'connectError',text:error.message,
                  callback:function(){
                    //console.log('test');
                  }})
              });
          },
          _onDataSelect:function(e){
            this.pageSelect = 1;
            this.$$('panel-right')._setWidth('95%');
            this.getDatalistQuota(e.detail.key);
            this.getKey = e.detail.key;
          },
          getDatalistQuota:function(key){
            this.fire('toast',{status:'load'});
            axios.get('./eu/calculate/spreadsheets?id='+key)
            .then((response)=>{
               this.fire('toast',{
                  status:'success',
                  callback:()=>{
                    this.$$('panel-right').toggle();
                  }
                });
                this.dataListQuota = response.data;
               
            })   
            .catch((error)=>{

            })
          },
          _confirmData:function(){
              this.fire('toast',{
              status:'openDialog',
              text:'ต้องการลบข้อมูลใช่หรือไม่ ?',
              confirmed:this._deleteData.bind(this)
            })
          },
          _saveData:function(e){
            console.log(e.detail);
            this.fire('toast',{status:'load'});
            axios.put('/eu/calculate/state/allocate',{allocate_id:e.detail})
            .then((response)=>{
              console.log("success");
              console.log('save::',response.data);
              this.textToast = 'บันทึกข้อมูลสำเร็จ';
              this.fire('toast',{
                status:'success',
                text:this.textToast,
                callback:function(){
                //console.log('test');
                
                }
              });
              this.$$("panel-right").toggle();
              this._getDatalist();
              // this._getYear();
              // this._getDatalist(this.selectYear);
            })
            .catch((error)=>{
              console.log("error");
              console.log(error);
            });
          },
          _deleteData:function(result,detail){
             console.log('key:',this.getKey);
            // var data = detail.data;
            if(result == true){
                //this.fire('toast',{status:'load'});
                // http://localhost:3000/api/eu/calculate/allocate_quota?id=462106d4-ea26-4151-9cf1-07371ed01a9d
                axios.delete('/eu/calculate/allocate_quota',{
                params:{
                  id : this.getKey
                }
                })
                .then((response)=>{
                  console.log("success");
                  this.textToast = 'ลบข้อมูลสำเร็จ';
                  console.log(response);
                  this.$$('panel-right').toggle();
                  this._getDatalist();
                })
                .catch((error)=>{
                  console.log("error");
                  console.log(error);
                });
            }
          }


        });
    </script>
</dom-module>
