<link rel="import" href="./../components/panel-right/panel-right.html">
<link rel="import" href="./components/allocate-list.html">
<!--<script src="./../../../bower_components/Numeral-js-npm/min/numeral.min.js"></script>-->
<dom-module id="page-amount">
  <style is="custom-style" include="iron-flex iron-flex-factors iron-flex-alignment gl-size gl-color">
    * {
      font-family: 'rsuregular', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    
    .header {
      padding: 10px 0px 10px 10px;
      background-color: var(--paper-grey-100);
      color: var(--paper-grey-600);
      font-size: var(--font-size-h4);
      font-family: 'rsuregular', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    
    .registor {
      margin: 20px;
    }
    
    .title {
      text-align: center;
      font-size: var(--font-size-h3);
      font-family: 'rsuregular', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    
    .searchBox {
      padding: 5px;
      background-color: var(--gl-gray-lighter-color);
    }
    
    .elevation {
      border-radius: 5px;
      margin: 10px;
      padding: 5px;
    }
    
    .searchBorder {
      border: 1px solid var(--gl-gray-light-color);
      margin: 15px;
      border-radius: 3px
    }
    
    paper-material {
      background-color: var(--gl-white-color);
    }
    
    gl-search-input {
      margin: 30px 0px 0px 0px;
    }
    
    table.gl-table-default {
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    table.gl-table-default,
    th,
    td {
      border-bottom: 1px solid #ddd;
    }
    
    th,
    td {
      padding: 15px;
    }
    
    th {
      text-align: left;
      background-color: #F1F1F1;
    }
    
    td {
      text-align: left;
    }
    
    tr:hover {
      background-color: #F1F1F1;
    }
    
    .contentHeader {
      font-size: 22px;
      text-align: center;
    }
  </style>
  <template>

    <content-panel>
      <grid>
        <!-- <paper-material elevation="1" class="elevation"> -->


        <div class="layout vertical registor">
          <div class="flex">
            <div class="layout horizontal end-justified">
              <!--<paper-button raised class="gl-btn-primary"on-tap="_toggleDrawer" id="addRedRegExporter"><iron-icon icon="add"></iron-icon> เพิ่มทะเบียนผู้ส่งออกข้าว</paper-button>-->
            </div>
          </div>
          <div class="flex title">
            ปริมาณส่วนจัดสรรข้าวภายใต้โควตาสหภาพยุโรปรายบริษัท
          </div>
          <div class="flex searchBox searchBorder">
            <div class="layout horizontal">
              <div class="flex"></div>
              <div class="flex-2">
                <gl-form-dropdown-menu label="ปีโควตา">
                  <paper-listbox class="dropdown-content" attr-for-selected="year" selected="{{selectQuotaYear}}">
                    <template is="dom-repeat" items="{{getQuotaYear}}">
                      <paper-item year="{{item}}">{{item}}</paper-item>
                    </template>
                  </paper-listbox>
                </gl-form-dropdown-menu>
              </div>
              <div class="flex-2">
                <gl-form-dropdown-menu label="ประเภทข้าว">
									<paper-listbox class="dropdown-content" attr-for-selected="rice-type-id" selected="{{selectTypeRice}}">
										<template is="dom-repeat" items="{{getTypeRice}}">
											<paper-item on-tap="_typeRiceName_th" rice-type-id="{{item.id}}">{{item.type_rice_name_th}}</paper-item>
										</template>
									</paper-listbox>
								</gl-form-dropdown-menu>
              </div>
              <div class="flex-2">
                <gl-form-dropdown-menu label="การคำนวณครั้งที่">
                  <paper-listbox class="dropdown-content" attr-for-selected="year" selected="{{selectQuotaOrdinal}}">
                    <template is="dom-repeat" items="{{getQuotaOrdinal}}">
                      <paper-item year="{{item}}">{{item}}</paper-item>
                    </template>
                  </paper-listbox>
                </gl-form-dropdown-menu>
              </div>
              <div class="flex-2">
                <paper-button class="gl-btn-primary" raised on-tap="_getAllocate" disabled$="[[_disableSearch(selectQuotaYear,selectTypeRice,selectQuotaOrdinal)]]">ค้นหา</paper-button>
              </div>
            </div>
            <div class="flex"></div>
          </div>
        </div>
        <div class="contentHeader">สรุปการคำนวณส่วนจัดสรรข้าวภายใต้โควตาสหภาพยุโรป</div>
        <div class="flex" style="border:1px solid #ddd; margin:30px;">
          <allocate-list on-toggle-drawer="_toggleDrawer" on-data-select="_onDataSelect" data-allocate="[[dataAllocate]]"></allocate-list>
        </div>
        <div class="layout horizontal end-justified" style="margin:0px 20px 0px 0px;">
          <paper-button raised class="gl-btn-primary">
            <iron-icon icon="print"></iron-icon>
            <span style="margin:0px 5px 0px 10px">ออกประกาศ</span>
          </paper-button>
        </div>
        </div>
        <!-- </paper-material> -->

      </grid>

    </content-panel>
    <panel-right title="รายละเอียดการจัดสรรโควตา">
      <template is="dom-if" if="[[rendered]]">
        <amount-allocation-edit data-select="{{dataSelected}}" data-quota="{{dataQuota}}"></amount-allocation-edit>
      </template>
    </panel-right>
  </template>
  <script>
        Polymer({
            is: "page-amount",
            observers:[
              '_yearQuoataAndTypeRiceChanged(selectQuotaYear,selectTypeRice)'],
            properties: {
                layerContent: {
                    type: String,
                    value: "detailRegExporter"
                },
                dataAmount:{
                    type: Object,
                    value:
                      {
                        header:[
                          'ลำดับที่',
                          'ผู้ส่งออก',
                          'งวดที่ 1 (มกราคม)',
                          'ยอดปรับปรุงงวดที่ 1',
                          'งวดที่ 2 (เมษายน)',
                          'ยอดปรับปรุงงวดที่ 2',
                          'งวดที่ 3 (กรกฏาคม)',
                          'ยอดปรับปรุงงวดที่ 3',
                          'ปริมาณโควต้ารวม',
                          'รวมยอดปรับปรุง'
                        ],
                        row1:[
                            '1',
                            'กมลกิจ บจก',
                            '449.50',
                            '449.00',
                            '224.75',
                            '225.00',
                            '224.75',
                            '225.00',
                            '899.00',
                            '899.00'
                          ],
                          row2:[
                            '2',
                            'กรุงเทพค้าข้าว',
                            '67.50',
                            '67.00',
                            '33.75',
                            '34.00',
                            '33.75',
                            '34.00',
                            '135.00',
                            '135.00'
                          ]  
                      }
                },
                searchType: {
                    type: Object,
                    value: [{
                        id: 1,
                        name: 'ทั้งหมด'
                    }, {
                        id: 2,
                        name: 'ผู้ส่งออกที่ถูกระงับ'
                    } ]
                }
            },
           
            ready:function(){
              //var number = numeral('1000.32').format('0,0.00');
              //console.log(number);
               this._getQuotaYear();
               this._getTypeRice();
               Polymer.RenderStatus.afterNextRender(this,function(){
                this.importHref(this.resolveUrl('./components/amount-allocation-edit.html'), (e)=>{
                    this.rendered = true;
                }, (e)=> {
                    console.log('error')
                });
              }); 
            },
            _yearQuoataAndTypeRiceChanged:function(yearQuoata,typeRice){
              this.selectQuotaOrdinal = "";
              axios.get('./eu/allocate/quota_ordinal',{
                params:{
                  quota_id:yearQuoata,
                  type_rice_id:typeRice
                }
              })
                .then((response)=>{
                    console.log("success!!");
                    console.log(response.data);
                    this.getQuotaOrdinal = response.data;
                })
                .catch((error)=>{
                    console.log("error");
                    console.log(error);
                });
            },
            _typeRiceName_th:function(e){
             //console.log(e.target.textContent);
             this.getTypeRiceName = e.target.textContent;
              //console.log(this.getTypeRice);
            },
            _toggleDrawer: function(e) {
               this.$$("panel-right").toggle();
            },
            _getQuotaYear: function(){
              axios.get('./eu/quota/year')
              .then((response)=>{
                console.log("success");
                this.getQuotaYear = response.data;
              })
              .catch((error)=>{
                console.log("error");
                console.log(error.message);
                this.fire('toast',{status:'connectError',text:error.message,
                  callback:function(){
                  }})
              });
            },
            _getTypeRice:function(){
                axios.get('./eu/type_rice/')
                .then((response)=>{
                    console.log("success!!");
                    console.log(response.data);
                    this.getTypeRice = response.data;
                })
                .catch((error)=>{
                    console.log("error");
                    console.log(error);
                });
            },
            _onDataSelect:function(e){
              console.log(e.detail);
              this.fire('toast',{status:'load'});
              this.dataSelected = e.detail;
              this.dataQuota = {
                quota_id : this.selectQuotaYear,
                type_rice_id : this.getTypeRiceName,
                ordinal_number : this.selectQuotaOrdinal
              }
              this.fire('toast',{status:'success',callback:function(){}});
              this.$$("panel-right").toggle();
            },
            _getAllocate:function(){
                axios.get('./eu/allocate/allocate',{
                  params:{
                    quota_id:this.selectQuotaYear,
                    type_rice_id:this.selectTypeRice,
                    ordinal_number:this.selectQuotaOrdinal
                  }
                })
                .then((response)=>{
                    this.dataAllocate = response.data;
                    console.log(this.dataAllocate);
                    
                })
                .catch((error)=>{
                    console.log(error);
                });
             },
             _disableSearch:function(quota_id,type_rice_id,ordinal_number){
               console.log(quota_id,type_rice_id,ordinal_number);
             }
        });
    </script>
</dom-module>