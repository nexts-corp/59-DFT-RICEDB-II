<script src="./../bower_components/rxjs/dist/rx.all.js"></script>
<script src="./../bower_components/paho-mqtt/src/mqttws31.js"></script>
<script>
nylonMqtt = { 
    client:new Paho.MQTT.Client("mqtt.codeunbug.com", Number(80), "1234"),
    onConnect:new Rx.Subject(),
    onMessage:new Rx.Subject(),
    onLost:new Rx.Subject(),
    on:function(event,callback){
        const firstToUpperCase = function( str ) {
            return str.substr(0, 1).toUpperCase() + str.substr(1);
        };

        var eventName = 'on'+firstToUpperCase(event)
        if(eventName=='onConnect' && nylonMqtt.connected){
            callback('onConnect')
        }else{
            nylonMqtt[eventName].subscribe(function (data) {
                callback(data);
            });
        }
    },
    subscribe:function(sub){
    nylonMqtt.client.subscribe(sub);
    },
    publish:function(topic,msg){
    var message = new Paho.MQTT.Message(msg);
    message.destinationName = topic;
    nylonMqtt.client.send(message);
    },
    onMqttConnect:function(){
    nylonMqtt.connected = true;
    nylonMqtt.onConnect.onNext('onConnect');
    
    },
    onMessageArrived:function(message){
    nylonMqtt.onMessage.onNext(message);
    },
    onConnectionLost:function(responseObject){
    if (responseObject.errorCode !== 0) {
        //console.log("onConnectionLost:"+responseObject.errorMessage);
        nylonMqtt.onLost.onNext(responseObject);
    }
    },
    connected:false 
};

nylonMqtt.client.onMessageArrived = nylonMqtt.onMessageArrived;
nylonMqtt.client.onConnectionLost = nylonMqtt.onConnectionLost;

nylonMqtt.client.connect({onSuccess:nylonMqtt.onMqttConnect});

// nylonMqtt.on('connect',function(data){
//     nylonMqtt.subscribe('testzz');
//     nylonMqtt.publish('testxx','abc');
//     console.log('ok',data);
// });

// nylonMqtt.on('message',function(data){
//     console.log(data.destinationName,data.payloadString);
// });



</script>