<script src="./../bower_components/rxjs/dist/rx.lite.min.js"></script>
<script src="./../bower_components/paho-mqtt/src/mqttws31.js"></script>
<script>
nylonMqtt = {} || nylonMqtt;

nylonMqttBehavior = {
    nylonMqttConnect:function(connectionName,hostName,port,clientId=null){

        const guid = function() {
            if(clientId==null){
                function s4() {
                    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
                }
                return s4() + s4() + s4() +  s4() + s4() + s4() + s4() + s4();
            }else{
                return clientId;
            }
        }

        nylonMqtt[connectionName] = {
             connected:false,
             onConnect:new Rx.Subject(),
             onMessage:new Rx.Subject(),
             onLost:new Rx.Subject()
        };

        nylonMqtt[connectionName].client = new Paho.MQTT.Client(hostName, Number(port), guid());

        nylonMqtt[connectionName].client.onMessageArrived = function(msg){
            nylonMqtt[connectionName].onMessage.onNext(msg);
        }
        nylonMqtt[connectionName].client.onConnectionLost = function(response){
            nylonMqtt[connectionName].onLost.onNext(response);
        }

        nylonMqtt[connectionName].client.connect({onSuccess:function(){
            nylonMqtt[connectionName].connected = true;
            nylonMqtt[connectionName].onConnect.onNext(nylonMqtt[connectionName].client);
        }});
    },
    nylonMqttOn:function(connectionName,event,callback){
        if(event=="connected"){
            if(nylonMqtt[connectionName].connected==false){
                nylonMqtt[connectionName].onConnect.subscribe(function (data) {
                    callback(data);
                });
            }else{
                callback(data);
            }
            
        }else if(event=="message"){
            nylonMqtt[connectionName].onMessage.subscribe(function (data) {
                callback(data.destinationName,data.payloadString,data);
            });
        }else if(event=="lost"){
            nylonMqtt[connectionName].onLost.subscribe(function (response) {
                callback(response);
            });
        }
    },
    nylonMqttPublish:function(connectionName,topic,msg){
        var message = new Paho.MQTT.Message(msg);
        message.destinationName = topic;
        nylonMqtt[connectionName].client.send(message);
    }
};


</script>