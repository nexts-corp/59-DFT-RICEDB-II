<link rel="import" href="../controller/g2gShipmentController.html">
<dom-module id="detail-exporter-ship">
  <style include="iron-flex iron-flex-factors iron-flex-alignment gl-styles">
    *{
      font-family: 'CSChatThaiUI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .title {
      text-align: center;
      font-size: var(--font-size-h4);
    }
  </style>
  <template>
    <gl-form-panel set-padding="10px 20px 10px 20px">
    <!-- <template is="dom-if" if="[[!checkBtnView(approve)]]"> -->
      <gl-form-panel-head set-border="1px" set-padding="10px 20px 20px 20px">
        <paper-icon-button icon="create" raised on-tap="editInput" title="Edit" index="[[index]]"></paper-icon-button>
        <paper-icon-button icon="delete" raised on-tap="shipmentDelete" title="Delete" id="[[itemPrimary.shm_det_id]]"></paper-icon-button>
      </gl-form-panel-head>
    <!-- </template> -->


    <gl-form-panel-body>
      <div class="title">รายละเอียดผู้ส่งออกและเรือ</div>
    </gl-form-panel-body>

  <gl-form-panel-body>
    <gl-grid-row width="{{getWidth}}">
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box class="required" required  id="exporter_id" label="ผู้ส่งออก" always-float-label item-label-path="seller_name_en"
         item-value-path="exporter_id"  items="{{dataForSelect.seller}}" value="{{data.exporter_id}}" ></gl-combo-box>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,8]]">//[[data.exporter_id]]
        <gl-form-input disabled label="Tel." placeholder="ใส่รายละเอียด" value="{{_getSellerPhone(data.exporter_id,dataForSelect)}}" always-float-label></gl-form-input>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box  required class="required" label="B/L No." always-float-label item-label-path="bl_no"
           item-value-path="bl_no" items="{{blNos}}" value="{{data.bl_no}}"></gl-combo-box>
        <!-- <gl-form-input  required class="required"label="B/L No."always-float-labelerror-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด"  value="{{data.bl_no}}"></gl-form-input> -->
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input  disabled required class="required" label="Booking No."always-float-labelerror-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด"  value="{{data.book_no}}"></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box disabled  required class="required"label="Shipping Agent"always-float-label item-label-path="carrier_name"
           item-value-path="carrier_id" items="{{dataForSelect.carrier}}" value="{{data.carrier_id}}"></gl-combo-box>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box disabled required class="required"label="Shipping Line"always-float-label item-label-path="shipline_name"
           item-value-path="shipline_id" items="{{dataForSelect.shipline}}" value="{{data.shipline_id}}" ></gl-combo-box>
      </gl-grid-col>
      <!-- [[_getShip(data.shipline_id,dataForSelect)]] -->
      <template is="dom-repeat" items="[[data.ship]]">
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
          <gl-combo-box disabled required class="required"label="Vessel [[_ObcountIndex(index)]]"always-float-label item-label-path="ship_name"
           item-value-path="ship_id" items="[[_getShip(data.shipline_id,dataForSelect)]]" value="{{item.ship_id}}"></gl-combo-box>
        </gl-grid-col>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
          <gl-form-input disabled required class="required"label="Voy No."always-float-label  error-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด" value="{{item.ship_voy_no}}"
          name="voidNo"></gl-form-input>
        </gl-grid-col>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]"></gl-grid-col>
      </template>

    </gl-grid-row>
    <gl-grid-row width="{{getWidth}}">
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box disabled required class="required"label="Surveyor"always-float-label item-label-path="surveyor_name"
          item-value-path="surveyor_id" items="{{dataForSelect.surveyor}}" value="{{data.surveyor_id}}"></gl-combo-box>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled required class="required"label="Lot No."always-float-label  error-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด" value="{{data.ship_lot_no}}"
        name="lotNo"></gl-form-input>
      </gl-grid-col>



      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box disabled required class="required"label="Port of loading"always-float-label item-label-path="port_name"
         item-value-path="port_id" items="{{dataForSelect.pol}}" value="{{data.load_port_id}}"></gl-combo-box>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <vaadin-date-picker disabled required class="required" label="ETD"always-float-label  value="{{data.etd_date}}"></vaadin-date-picker>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <vaadin-date-picker disabled required class="required"  label="ETA"always-float-label value="{{data.eta_date}}"></vaadin-date-picker>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box disabled required class="required"label="Port of destination"always-float-label  item-label-path="port_name"
        item-value-path="port_id" items="{{dataForSelect.pod}}"  value="{{data.dest_port_id}}"></gl-combo-box>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box disabled required class="required"label="Place of Delivery"always-float-label  item-label-path="port_name"
        item-value-path="port_id" items="{{dataForSelect.pod}}" value="{{data.deli_port_id}}"></gl-combo-box>
      </gl-grid-col>


      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        [[changeString2Num(data.*,'num_of_container')]]
          <gl-form-input disabled required class="required"label="จำนวนตู้คอนเทนเนอร์"always-float-label error-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด" value="{{data.num_of_container}}"></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        [[changeString2Num(data.*,'weight_per_container')]]
        <gl-form-input disabled required class="required"label="ตู้ละ (ตัน)"always-float-label error-message="กรุณาใส่รายละเอียด"  placeholder="ใส่รายละเอียด" value="{{data.weight_per_container}}" ></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <vaadin-date-picker disabled required class="required"label="Packing Date"always-float-label class="requested" value="{{data.packing_date}}"></vaadin-date-picker>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="Packing Time"always-float-label required class="required" type="time" error-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด" value="{{data.packing_time}}" ></gl-form-input>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <vaadin-date-picker disabled label="Production Date"always-float-label required class="required" value="{{data.product_date}}" ></vaadin-date-picker>
      </gl-grid-col>
    </gl-grid-row>
      </gl-form-panel-body>

  <gl-form-panel-body>
    <div class="title">รายละเอียดการส่งมอบ</div>
  </gl-form-panel-body>

  <gl-form-panel-body>
    <gl-grid-row>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="Confirmation Letter" value="[[dataForSelect.cl_no]]" always-float-label></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box id="type_rice_id" label="ชนิดข้าว" item-label-path="type_rice_name_en"
         class="required" required  item-value-path="type_rice_id" items="[[dataForSelect.cl_type_rice]]" value="{{data.type_rice_id}}" always-float-label></gl-combo-box>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box id="package_id" label="Package (kg/PP Bag)" item-label-path="package_name"
         class="required" required  item-value-path="package_id" items="[[_getRiceTypeForPackage(data.type_rice_id,dataForSelect)]]" value="{{data.package_id}}" always-float-label></gl-combo-box>
      </gl-grid-col>
      [[_getPackageForPrice(data.package_id,dataForSelect)]]
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="Price (USD/MT)" value="[[price.price_per_ton]]" always-float-label></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="น้ำหนักกระสอบ (gram/bag)"  value="[[price.package_weight_bag]]" always-float-label></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        [[changeString2Num(data.*,'shm_det_quantity')]]
        <gl-form-input class="required" required label="จำนวน/ตัน" error-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด" value="{{data.shm_det_quantity}}" always-float-label></gl-form-input>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="MARKS"  value="[[dataForSelect.buyer_masks]]" always-float-label></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="Quantity (BAGS)" value="[[price.quantityBag]]" always-float-label></gl-form-input>
      </gl-grid-col>
    </gl-grid-row>

    <gl-grid-row>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="G.W. WEIGHT (M/T)"  value="[[price.gw]]" always-float-label></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="N.W. WEIGHT (M/T)"  value="[[price.nw]]" always-float-label></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input disabled label="T.W. WEIGHT (M/T)"  value="[[price.tw]]" always-float-label></gl-form-input>
      </gl-grid-col>
    </gl-grid-row>
    <gl-grid-row>
      <gl-grid-col width="[[getWidth]]" grid="[[500,12],[700,7]]"></gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[500,12],[700,2]]">
        [[changeString2Num(data.*,'origin_page')]]
        <gl-form-input class="required" required  label="ORIGINALS"  class="w padL" value="{{data.origin_page}}" always-float-label></gl-form-input>
      </gl-grid-col>
      <div class="top">/</div>
      <gl-grid-col width="[[getWidth]]" grid="[[500,12],[700,2]]">
        [[changeString2Num(data.*,'nn_page')]]
        <gl-form-input id="testtttt" class="required" required  label="N/N"  class="w" value="{{data.nn_page}}" always-float-label></gl-form-input>
      </gl-grid-col>
    </gl-grid-row>
    <!-- <paper-button  class="gl-btn-success" raised on-tap="checkData" index="[[index]]">
      <iron-icon class="gl-icon-size" icon="save"></iron-icon>checkData</paper-button> -->
  </gl-form-panel-body>
  <gl-form-panel-footer set-padding="10px 20px 0px 20px">
    <!-- <template is="dom-if" if="[[checkBtnView(checkBtn)]]"> -->
      <paper-button  class="gl-btn-success" raised on-tap="saveShipment" >
        <iron-icon class="gl-icon-size" icon="save"></iron-icon>บันทึก</paper-button>
      <!-- </template> -->
  </gl-form-panel-footer>

  <!-- <template is="dom-if" if="[[insertShipment]]"> -->
    <gl-form-panel-footer>
      <paper-button class="gl-btn-danger" raised on-tap="cancalShow">
        </iron-icon>ยกเลิก</paper-button>
      <paper-button class="gl-btn-success" raised on-tap="addExporter">
      </iron-icon>เพิ่ม</paper-button>
    </gl-form-panel-footer>
  <!-- </template> -->
  </template>
  <script>
    Polymer({
      is: "detail-exporter-ship",
      behaviors: [
          g2gCongtroller,
          g2gModelBehavior,
          g2gShipmentController
      ],
      properties: {
        data: {
          type: Object,
          value:{}
        },
        price:{
          type: Object,
          value:{}
        },
        dataForSelect:{
          type:Object,
        }
      },
      observers:[
        '_oBcheckBl(data.bl_no,dataForSelect)',
        '_obCalWeight(data.shm_det_quantity,dataForSelect)',
        // 'check(dataForSelect)'
      ],

      // check:function (data) {
      //   console.log('data =>',data);
      //   this.dataForSelect=data;
      //   console.log(this.dataForSelect);
      // },
      _oBcheckBl:function (bl_no,dataForSelect) {
        if (bl_no) {
          let dataContract = this.blNos.filter((blNos)=> blNos.bl_no == bl_no );
          let blNo =  Object.assign(this.data ,dataContract[0]);
          // console.log(this.dataForSelect.ships);
          this.data = blNo;
          this.notifyPath('data.bl_no');
          this.notifyPath('data.book_no');
          this.notifyPath('data.carrier_id');
          this.notifyPath('data.deli_port_id');
          this.notifyPath('data.dest_port_id');
          this.notifyPath('data.eta_date');
          this.notifyPath('data.etd_date');
          this.notifyPath('data.load_port_id');
          this.notifyPath('data.num_of_container');
          this.notifyPath('data.packing_date');
          this.notifyPath('data.packing_time');
          this.notifyPath('data.product_date');
          this.notifyPath('data.ship');
          this.notifyPath('data.ship_lot_no');
          this.notifyPath('data.shipline_id');
          this.notifyPath('data.surveyor_id');
          this.notifyPath('data.weight_per_container');
        }
      },
      _getSellerPhone:function (exporter_id,dataForSelect) {
        if (exporter_id) {
          let tel = this.dataForSelect.seller.filter((exporters)=> exporters.exporter_id == exporter_id );
          return tel[0].seller_phone;
        }
      },

      _getRiceTypeForPackage:function (type_rice_id,dataForSelect) {
        if (type_rice_id) {
            // let type_rice_id = e.detail.value;
            let typeRice = this.dataForSelect.cl_type_rice.filter((typeRices)=> typeRices.type_rice_id == type_rice_id );
            this.dataForSelect.package = typeRice[0].package;
            this.notifyPath('dataForSelect.package');
            // this.data.package_id='',
            // this.data.shm_det_quantity='',
            this.notifyPath('data.package_id');
            this.notifyPath('data.shm_det_quantity');
            return typeRice[0].package
        }
      },
      _getPackageForPrice:function (package_id,dataForSelect) {
        if (package_id) {
          let packing = this.dataForSelect.package.filter((packageing)=> packageing.package_id == package_id );
          this.price=packing[0];
          // this.data.shm_det_quantity='',
          this.notifyPath('data.shm_det_quantity');
          this.notifyPath('price.price_per_ton');
          this.notifyPath('price.package_weight_bag');
        }
      },
      _obCalWeight:function (shm_det_quantity,dataForSelect) {
        let pack = this.price;
        if (typeof pack != 'undefined') {
             this.price.quantityBag = ((parseFloat(shm_det_quantity) * parseFloat(1000)) / parseFloat(pack.package_kg_per_bag));
             this.notifyPath('price.quantityBag');
             this.price.sumGW = ((parseFloat(this.price.quantityBag) * (parseFloat(pack.package_kg_per_bag) + (parseFloat(pack.package_weight_bag) / parseFloat(1000))) / parseFloat(1000)));
             this.notifyPath('price.sumGW');
             this.price.gw = this.price.sumGW.toFixed(3);
             this.notifyPath('price.gw');
             this.price.nw = parseFloat(shm_det_quantity).toFixed(3);
             this.notifyPath('price.nw');
             this.price.tw = ((parseFloat(this.price.quantityBag)*(parseFloat(pack.package_weight_bag)/parseFloat(1000)))/parseFloat(1000)).toFixed(3);
             this.notifyPath('price.tw');
        }
      },
      addExporter:function () {
        // console.log(this.data);
        // this._cleanShipmentData(this.data,(data)=>{
          // data.shm_id=this.dataForSelect.shm_id;
          // console.log(data);
          // console.log(this.data);
          console.log(this.dataForSelect);
          // this.insert('./g2g/shipment/detail/insert',data, () => {
          //   console.log('เพิ่มได้');
          // });
        // })
      },
      _cleanShipmentData:function (data,callback) {
        let el = Polymer.dom(this.root).querySelectorAll('.required');
        let stat = el.map((el)=> el.validate());
          if (stat.every(elem => elem == true)) {
            let { bl_no,book_no,carrier_id,deli_port_id,dest_port_id,eta_date,etd_date,
                  load_port_id,num_of_container,packing_date,packing_time,product_date,
                  ship_lot_no,shipline_id,surveyor_id,weight_per_container,
                  type_rice_id,package_id,shm_det_quantity,origin_page,nn_page,
                  exporter_id} = data;
            let newData ={ bl_no,book_no,carrier_id,deli_port_id,dest_port_id,eta_date,etd_date,
                            load_port_id,num_of_container,packing_date,packing_time,product_date,
                            ship_lot_no,shipline_id,surveyor_id,weight_per_container,
                            type_rice_id,package_id,shm_det_quantity,origin_page,nn_page,exporter_id};
            newData.ship = new Array();
            newData.eta_date = new Date (newData.eta_date);
            newData.etd_date = new Date (newData.etd_date);
            newData.packing_date = new Date (newData.packing_date);
            newData.product_date = new Date (newData.product_date);
            data.ship.map((ships)=>{
              newData.ship.push({ship_id:ships.ship_id,ship_voy_no:ships.ship_voy_no});
            });
            callback(newData)
          }
      }

    });
  </script>
</dom-module>
