<link rel="import" href="../controller/g2gShipmentController.html">
<dom-module id="bill-detail-sm">
  <style include="iron-flex iron-flex-factors iron-flex-alignment gl-styles">
    *{
      font-family: 'CSChatThaiUI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    .btnVessel{
      height: 2em;
      width: 2em;
    }
    .btnVessel > iron-icon{
      height: 1em;
      width: 1em;
      margin-right: 0.5em;
    }
    div.title{
      margin-top: 1em;
      text-align: center;
      font-size: var(--font-size-h4);
    }
  </style>
  <template>
    <template is="dom-if" if="[[_isViewing(isInputDisabled)]]">
      <div class="horizontal end-justified layout">
        <paper-icon-button id="editConfirm" class="crud" icon="create" raised on-tap="editInput"  ></paper-icon-button>
        <paper-tooltip for="editConfirm" offset="0">Edit Bl/NO</paper-tooltip>
       </div>
    </template>
[[dataBlDetail]]//
      <gl-form-panel-body>
        <div class="title">Bill of Landing Number</div>
      </gl-form-panel-body>
    <gl-form-panel-body>
    <gl-grid-row width="{{getWidth}}">
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input  required class="required"label="B/L No."always-float-labelerror-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด"  value="{{data.bl_no}}" disabled="[[isInputDisabled]]"></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input  required class="required"label="Booking No."always-float-labelerror-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด"  value="{{data.book_no}}" disabled="[[isInputDisabled]]"></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box  required class="required"label="Shipping Agent"always-float-label item-label-path="carrier_name" disabled="[[isInputDisabled]]"
           item-value-path="carrier_id" items="{{dataForSelect.carrier}}" value="{{data.carrier_id}}"></gl-combo-box>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box required class="required"label="Shipping Line"always-float-label item-label-path="shipline_name" disabled="[[isInputDisabled]]"
           item-value-path="shipline_id" items="{{dataForSelect.shipline}}" value="{{data.shipline_id}}" ></gl-combo-box>
      </gl-grid-col>

      <template is="dom-repeat" items="[[data.ship]]">
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
          <gl-combo-box required class="required"label="Vessel [[_ObcountIndex(index)]]" always-float-label item-label-path="ship_name" disabled="[[isInputDisabled]]"
           item-value-path="ship_id" items="[[_getShip(data.shipline_id,dataForSelect)]]" value="{{item.ship_id}}"></gl-combo-box>
        </gl-grid-col>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
          <gl-form-input required class="required"label="Voy No."always-float-label  error-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด" value="{{item.ship_voy_no}}" disabled="[[isInputDisabled]]"
          name="voyNo"></gl-form-input>
        </gl-grid-col>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]"></gl-grid-col>
      </template>
      <template is="dom-if" if="[[!isInputDisabled]]">
        <div class="horizontal end-justified layout">
        <paper-button raised class="gl-btn-primary btnVessel" on-tap="addShip" hidden="[[hiddenInsertVessel]]">
          <iron-icon icon="add"></iron-icon>เพิ่มเรือ</paper-button>
        </div>
      </template>



    </gl-grid-row>
    <gl-grid-row width="{{getWidth}}">
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box required class="required"label="Surveyor"always-float-label item-label-path="surveyor_name" disabled="[[isInputDisabled]]"
          item-value-path="surveyor_id" items="{{dataForSelect.surveyor}}" value="{{data.surveyor_id}}"></gl-combo-box>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input required class="required"label="Lot No."always-float-label  error-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด" value="{{data.ship_lot_no}}" disabled="[[isInputDisabled]]"
        name="lotNo"></gl-form-input>
      </gl-grid-col>



      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box required class="required"label="Port of loading"always-float-label item-label-path="port_name" disabled="[[isInputDisabled]]"
         item-value-path="port_id" items="{{dataForSelect.pol}}" value="{{data.load_port_id}}"></gl-combo-box>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <vaadin-date-picker required class="required" label="ETD"always-float-label  value="{{data.etd_date}}" disabled="[[isInputDisabled]]"></vaadin-date-picker>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <vaadin-date-picker required class="required"  label="ETA"always-float-label value="{{data.eta_date}}" disabled="[[isInputDisabled]]"></vaadin-date-picker>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box required class="required"label="Port of destination"always-float-label  item-label-path="port_name" disabled="[[isInputDisabled]]"
        item-value-path="port_id" items="{{dataForSelect.pod}}"  value="{{data.dest_port_id}}"></gl-combo-box>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-combo-box required class="required"label="Place of Delivery"always-float-label  item-label-path="port_name" disabled="[[isInputDisabled]]"
        item-value-path="port_id" items="{{dataForSelect.pod}}" value="{{data.deli_port_id}}"></gl-combo-box>
      </gl-grid-col>


      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        [[changeString2Num(data.*,'num_of_container')]]
          <gl-form-input required class="required"label="จำนวนตู้คอนเทนเนอร์"always-float-label error-message="กรุณาใส่รายละเอียด" pattern="[0-9]*" placeholder="ใส่รายละเอียด" value="{{data.num_of_container}}" disabled="[[isInputDisabled]]"></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        [[changeString2Num(data.*,'weight_per_container')]]
        <gl-form-input required class="required"label="ตู้ละ (ตัน)"always-float-label error-message="กรุณาใส่รายละเอียด"  placeholder="ใส่รายละเอียด" disabled="[[isInputDisabled]]"
          value="{{data.weight_per_container}}" ></gl-form-input>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <vaadin-date-picker required class="required"label="Packing Date"always-float-label class="requested" value="{{data.packing_date}}" disabled="[[isInputDisabled]]"></vaadin-date-picker>
      </gl-grid-col>
      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <gl-form-input label="Packing Time"always-float-label required class="required" type="time" error-message="กรุณาใส่รายละเอียด" placeholder="ใส่รายละเอียด" value="{{data.packing_time}}" disabled="[[isInputDisabled]]"></gl-form-input>
      </gl-grid-col>

      <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
        <vaadin-date-picker label="Production Date"always-float-label required class="required" value="{{data.product_date}}" disabled="[[isInputDisabled]]"></vaadin-date-picker>
      </gl-grid-col>
    </gl-grid-row>
      </gl-form-panel-body>

    <template is="dom-if" if="[[!_isViewing(isViewSeleted)]]">
    <gl-form-panel-footer>
      <paper-button class="gl-btn-danger" raised on-tap="cancelInsertShipment">
        ย้อนกลับ</paper-button>
      <paper-button class="gl-btn-success" raised on-tap="addBl">
      เพิ่ม</paper-button>
    </gl-form-panel-footer>
    </template>
    <template is="dom-if" if="[[_isViewing(isViewSeleted)]]">
    <gl-form-panel-footer>
      <paper-button class="gl-btn-danger" raised on-tap="cancelInsertShipment">
        ย้อนกลับ</paper-button>
      <paper-button class="gl-btn-primary" raised on-tap="editBl" hidden="[[isInputDisabled]]">
      บันทึก</paper-button>
    </gl-form-panel-footer>
    </template>
  </template>
  <script>
    Polymer({
      is: "bill-detail-sm",
      behaviors: [
          g2gCongtroller,
          g2gShipmentController
      ],
      properties: {
        data: {
          type: Object,
          value:{ship:[{ship_id:'',ship_voy_no:''}]}
        },
        dataForSelect:{
          type: Object,
        },
        hiddenInsertVessel:{
          type:Boolean,
          value:false
        }
      },
      observers:[
        '_oBChangeBooking(data.bl_no)',
        '_oBChangePod(data.dest_port_id)',
        '_getPod(dataForSelect)',
        '_oBCheckVessel(data.ship.*)'
      ],
      addBl:function () {
        // console.log(this.data);
        this._cleanDataBl(this.data,(data)=>{
//   let  data =
// {bl_no:"45",
// book_no:"45",
// carrier_id:"fe095c0f-c697-4200-affe-4dda4253c221",
// deli_port_id:"CNHUA",
// dest_port_id:"CNHUA",
// eta_date:"2016-12-29",
// etd_date:"2016-12-26",
// load_port_id:"THLCH",
// num_of_container:80,
// packing_date:"2016-12-20",
// packing_time:"12:00",
// product_date:"2016-12-29",
// ship:[
//   {
//     ship_id:"4a1136d5-1e51-4838-a233-4b846940a435",
//     ship_voy_no:"4545",
//   },
//   {
//     ship_id:"b0ee3bc9-ff85-4621-8c32-a9b6a66b0174",
//     ship_voy_no:"454545",
//   }
// ],
// ship_lot_no:"45",
// shipline_id:"53da78d4-06c6-4433-b14b-e36405609611",
// surveyor_id:"73ed2a97-2852-48b2-bd69-6d4c651ba39b",
// weight_per_container:45,};
          this.fire('send-Bl-no',{detail:data});
        })
      },
      addShip:function () {
        this.push('data.ship',{ship_id:'',ship_voy_no:''});
      },
      editBl:function () {
        // console.log(this.data);
        this._cleanDataBl(this.data,(data)=>{
          console.log(data);
        });
      },
      _oBChangeBooking:function (bl_no) {
        this.data.book_no = bl_no;
        this.notifyPath('data.book_no');
      },
      _oBChangePod:function (dest_port_id) {
        this.data.deli_port_id = dest_port_id;
        this.notifyPath('data.deli_port_id');
      },
      // _getShip:function (e) {
      //   let shipline_id = e.detail.value;
      //   if(shipline_id){
      //     let ships = this.dataForSelect.shipInShipline.filter((shipline)=>{ return shipline.shipline_id == shipline_id });
      //     this.dataForSelect.ships = ships[0].ship;
      //     this.notifyPath('dataForSelect.ships');
      //   }
      // },
      _getPod:function (Pod) {
        let pol = Pod.countryPort.filter((countryport)=>  countryport.country_id == 'THA' );
        this.dataForSelect.pol = pol;
        this.notifyPath('dataForSelect.pol');
        let pod = Pod.countryPort.filter((countryport)=>  countryport.country_id == 'CHN' );
        this.dataForSelect.pod = pod;
        this.notifyPath('dataForSelect.pod');
        // console.log(pod[0].ship);
      },
      _oBCheckVessel:function (shipMany) {
        // set btnvessel
        if (shipMany.value < 3) {
          this.hiddenInsertVessel = true;
        }
      },
      // hiddenInsertVessel
      _cleanDataBl:function (data,callback) {
        let el = Polymer.dom(this.root).querySelectorAll('.required');
        let stat = el.map((el)=> el.validate());
          if (stat.every(elem => elem == true)) {
            let { bl_no,book_no,carrier_id,deli_port_id,dest_port_id,eta_date,etd_date,
                  load_port_id,num_of_container,packing_date,packing_time,product_date,
                  ship_lot_no,shipline_id,surveyor_id,weight_per_container} = data;
            let newData ={ bl_no,book_no,carrier_id,deli_port_id,dest_port_id,eta_date,etd_date,
                            load_port_id,num_of_container,packing_date,packing_time,product_date,
                            ship_lot_no,shipline_id,surveyor_id,weight_per_container};
            newData.ship = new Array();
            data.ship.map((ships)=>{
              newData.ship.push({ship_id:ships.ship_id,ship_voy_no:ships.ship_voy_no});
            });
            callback(newData)
          }
      }
    });
  </script>
</dom-module>
