<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="glon-behavior.html">


<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="gl-param.html">

<dom-module id="glon-system">
  <template>
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:app/:page" data="{{routeData}}">
    </app-route>
    <a id="changePath" href="#" style="display:none">link change path</a>

    <init-route app="[[appPath]]" page="[[pagePath]]"></init-route>
    
  </template>

  <script>
    (function() {
      'use strict';
    
    
      class GlonSystem {

        get observers() {
          return [
            '_routeChanged(routeData)'
          ];
        }

        beforeRegister() {
          this.is = 'glon-system';
          this.properties = {
            role:{
              type:Object,
              value:[
                { path:'app1/page1',role:['admin','manager','user1']}
              ]
            },
            appPath:{
              type:String
            },
            pagePath:{
              type:String
            }
          };
        }

        created(){
          window.gl.glonSystem = document.querySelector("glon-system");

          if(typeof localStorage.glLanguage == 'undefined'){
            localStorage.setItem("glLanguage", glonInit.language);
          }

          var decoded = jwt_decode('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiVXNlcjEiLCJyb2xlIjoiYWRtaW4ifQ.oRx_ieJoxSZPv7Y8lM03Qv8Qb24PVmuFpWBUxWEkBcg');
          this.auth = decoded;
        }

        _routeChanged(path){

          this._pageChange(path.app,path.page)

        }

        _pageChange(app,page){

          if(this.checkRole(app,page)){
            this._pageChange('error','403');
          }else{
          
            var resolvedPageUrl = this.resolveUrl(`../../../src/apps/${app}/${page}.html`);
            this.importHref(resolvedPageUrl, 
            ()=>{

              this.appPath = app;
              this.pagePath = page;

            }, 
            ()=>{
              this._pageChange('error','404');
            },
            true);
          }

        }

        changePath(path){
          this.$.changePath.setAttribute("href", path);
          this.$.changePath.click();
        }

        checkRole(app,page){
          var redirect = true;
          this.role.map((obj,index)=>{
            if(obj.path==(app+'/'+page)){
              obj.role.map((sObj)=>{
                if(this.auth.role==sObj){
                  redirect = false;
                }
              });
            }else{
              redirect = false;
            }
          });

          return redirect;
        }
          

      }

      Polymer(GlonSystem);

    })();

  </script>
</dom-module>