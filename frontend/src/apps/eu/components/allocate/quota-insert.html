<link rel="import" href="../../../../../bower_components/gl-form/gl-form-panel.html">
<dom-module id="quota-insert">
  <style is="custom-style" include="iron-flex iron-flex-alignment gl-color">
    .title{
      background-color: orange;
      padding: 10px;
      color:white;
    }
    table.default {
      border-collapse: collapse;
      width: 100%
    }

    table.default,
    th,
    td {
      border-bottom: 1px solid #ddd;
    }

    th,
    td {
      padding: 15px;
    }

    th {
      text-align: left;
      background-color: #F1F1F1;
      white-space: nowrap;
    }

    td {
      text-align: left;
      white-space: nowrap;
    }

    tr:hover {
      background-color: #F1F1F1;
    }
    .number{
      text-align: right;
    }
    header>div{
      text-align: center;
      font-size: 22px;
      padding: 20px;
    }
  </style>
  <template>
    <header>
      <div>การกำหนดปีโควตา</div>
    </header>
    <gl-form-panel set-padding = "0px 0px 20px 0px">
      <div class="title">รายละเอียดการจัดสรรโควตา</div>
      <gl-form-panel-body set-padding = "0px 0px 0px 0px" set-border="0px">
        <gl-grid-row width="{{getWidth}}">
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
            <gl-form-input label="ปีโควต้า" auto-validate error-message="กรุณาใสปีโควต้า" required placeholder="ใส่ปีโควต้า" value="2559" id="" disabled name=""></gl-form-input>
          </gl-grid-col>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
             <gl-form-dropdown-menu label="ประเภทข้าว">
                <paper-listbox class="dropdown-content">
                    <paper-item>ข้าวขาว</paper-item>
                    <paper-item>ข้าวหัก</paper-item>
                </paper-listbox>
            </gl-form-dropdown-menu>
          </gl-grid-col>
           <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]">
            <gl-form-input label="ยอดรวม" on-blur="_getSumValue" value="{{sum}}"></gl-form-input>
          </gl-grid-col>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
        </gl-grid-row>

        <table class="default" id="[[index]]">
          <tr>
            <th>จำนวนงวด</th>
            <th>สัดส่วน % </th>
            <th>คำนวณ</th>
            <th></th>
          </tr>
           <template is="dom-repeat" items="{{Period}}">
              <tr>
                  <td>งวดที่ : {{getIndex(index)}}</td>
                    <!--{{item.proportion}}-->
                  <td>
                    <gl-form-input auto-validate error-message="กรุณาใสจำนวน" value="{{item.percent}}" required placeholder="กรุณาใส่จำนวน" no-label-float></gl-form-input>
                  </td>
                  <td><gl-form-input auto-validate error-message="กรุณาใสจำนวน" value="{{_mathProportion(item.percent,item)}}" on-input="inputProportionChange" index="{{index}}" required placeholder="กรุณาใส่จำนวน" id="{{index}}" no-label-float></gl-form-input></td>
                  <td>
                    <paper-button on-tap="_delPeriod" item="{{item}}"><iron-icon icon="delete"></iron-icon></paper-button>
                  </td>
              </tr>
           </template>
          <tr>
            <td colspan="4"> 
              <paper-button on-tap="_addPeriod"><iron-icon icon="add"></iron-icon> เพิ่มงวด</paper-button>
             </td>
          </tr>
          <tr>
            <th>ปริมาณโควต้ารวม : {{_crossCheck(Period.*)}}</th>
            <th></th>
            <th></th>
            <th>
            <paper-button on-tap="_mathData">คำนวณ</paper-button>
            </th>
          </tr>
        </table>

      </gl-form-panel-body>
    </gl-form-panel>

    <div class="horizontal end-justified layout">
        <paper-button class="gl-btn-danger" raised>ยกเลิก</paper-button>
        <paper-button class="gl-btn-success" on-tap="_saveData" raised>บันทึก</paper-button>
    </div>

  </template>
  <script>
    Polymer({
      is: "quota-insert",
       properties: {
        Period: {
          type: Array,
          value: []
        },
        count:{
          type: Number,
          value: 0
        },
        sum:{
          type: Number
        },
        answer:{
          type: Number
        },
        data:{
          type: Object,
          value: function(){
            return {
              valueMain:'1234'};
            }
        }
       },
       getIndex:function(index){
         return parseInt(index)+1;
       },
       _getSumValue:function(){
         this.answer = this.sum;
         console.log(this.answer);
       },
      _addPeriod:function(){
        this.push('Period',{percent:0,proportion:0});
      },
      _delPeriod:function(e){
        this.splice('Period',this.Period.indexOf(e.currentTarget.item),1);
      },
      _getValue:function(e){
        var oldData = this.answer;
        console.log('1:',oldData);
        var mod = parseInt(e.target.value)/100;
        this.answer = parseInt(this.sum)*mod;
        this.answer = parseInt(oldData) - parseInt(this.answer);
        console.log('2:',this.answer);        
        this.$.test.textContent  = this.answer;
      },
      _mathProportion:function(percent,item){
        item.proportion = (parseFloat(this.sum)*parseFloat(percent))/100;
        console.log(this.Period);
        return item.proportion;
      },
      _crossCheck:function(data){
        var sum = 0;
        data.base.map((item)=>{
          if(typeof item.proportion!="undefined"){
            sum += item.proportion;
          }
        });
        return sum;
      },
      inputProportionChange:function(e){
        this.set('Period.'+e.target.index+'.proportion',parseFloat(e.target.value));
      }
      

    });
  </script>
</dom-module>
