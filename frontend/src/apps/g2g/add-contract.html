<link rel="import" href="panel-seleted.html"> ้
<link rel="import" href="panel-seleted-vessel.html">
<link rel="import" href="components/grid/nx-grid.html">
<link rel="import" href="components/content-panel.html">

<!-- <link rel="import" href="../database/con-db.html">
<link rel="import" href="components/promise/promise-insert.html">
<link rel="import" href="components/promise/promise-confirm.html">
<link rel="import" href="components/promise/promise-detail.html">
<link rel="import" href="components/promise/promise-fileup.html">
<link rel="import" href="components/vessel/vessel-print.html">
<link rel="import" href="components/period/period-page.html">
<link rel="import" href="components/period/period-insert.html">
<link rel="import" href="components/vessel/vessel-page.html"> -->

<link rel="import" href="data/db-gtog-contact.html">
<link rel="import" href="test.html">
<!-- <link rel="import" href="/components/vessel/shipment-insert.html"> -->
<link rel="import" href="components/vessel/shipment-insert.html">
<link rel="import" href="/bower_components/numeral-js/numeral-js.html">
<dom-module id="g2g-add-contract">
    <style is="custom-style" include="iron-flex iron-flex-factors iron-flex-alignment gl-color">
        * {
            font-family: 'rsuregular', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .left {
            margin: 0px 10px 0px 10px;
        }
        .button{
          margin: 5px;
        }
    </style>
    <template>


            <content-panel>

              <grid>

                <!-- <div class="horizontal end-justified layout">
                  <div class="button">
                    841/[[contractId]]
                    <paper-button raised class="gl-btn-primary"><iron-icon icon="add"></iron-icon> เพิ่มสัญญาการค้า</paper-button>
                  </div>
                </div> -->
                <nx-grid data="{{lastResponse}}" contract-id={{contractId}}>
                  <items type="primary">
                    <list item="contract_name" label="ชื่อ" width="flex-2" type="string"></list>
                    <list item="contract_quantity_total" label="ทั้งหมด (ตัน) /" width="flex" type="number"></list>
                    <list item="contract_quantity_confirm" label="ทำสัญญาแล้ว (ตัน) /" width="flex" type="number"></list>
                    <list item="contract_quantity_balance" label="คงเหลือ (ตัน)" width="flex" type="number"></list>
                  </items>
                  <items type="secondary" item="confirm_letter">
                    <list item="cl_no" label="Confirmation Letter" width="flex-2" type="string"></list>
                    <list item="cl_quantity_total" label="ทำสัญญาแล้ว (ตัน)/" width="flex" type="string"></list>
                    <list item="cl_quantity_sent" label="ส่งแล้ว (ตัน)/" width="flex" type="string"></list>
                    <list item="cl_quantity_balance" label="ยังไม่ได้สงมอบ (ตัน)" width="flex" type="string"></list>
                  </items>
                  <items type="secondaryHalf" item="sub">
                    <list item="" label="" width="flex" type="string"></list>
                    <list item="period" label="+ Add Confirmation Letter" width="flex-12" type="string"></list>
                  </items>
                  <items type="third" item="shipment">
                    <list item="shm_no" label="Shipment No" width="flex-6" type="string"></list>
                    <list item="shm_quantity" label="Tonne unit" width="flex-6" type="string"></list>
                    <!-- <list item="" label="" width="flex" type="string"></list>
                    <list item="" label="" width="flex" type="string"></list> -->
                  </items>
                  <items type="thirdHalf" item="shipment">
                    <list item="" label="" width="flex"></list>
                    <list item="shm_no" label="+ Add Shipment" width="flex-12" type="string"></list>
                  </items>
                  <template type="primary">
                    <input placeholder="text" value="primary">
                  </template>
            <template type="secondary">
                    <input placeholder="text" value="secondary">
                  </template>
            <template type="third">
                    <input placeholder="text" value="third">
                  </template>
            </nx-grid>
            </grid>
            <panel>
                <template is="dom-if" if="[[loaded]]">


                <div class="left">
                    <iron-pages selected="{{vesselPage}}">
                        <panel-seleted>
                            <section-content name="detail">
                                <iron-pages selected="{{layerContent}}" attr-for-selected="name">
                                    <promise-detail name="primary" data="{{dataSelect}}" type-rice=[[typeRice]]></promise-detail>
                                    <promise-confirm
                                                      name="secondary"
                                                      confirm-letter="{{confirmLetter}}"
                                                      contract-id="[[contractId]]"
                                                      package=[[package]]
                                                      incoterms=[[incoterms]]
                                                      on-confirm-mation-common="confirmMationCommon"></promise-confirm>
                                    <promise-insert name="secondaryHalf" package=[[package]] contract-id="[[contractId]]" incoterms=[[incoterms]]></promise-insert>
                                    <!-- <shipment-insert name="thirdHalf"></shipment-insert> -->
                                </iron-pages>
                            </section-content>
                            <section-content name="print">
                                <vessel-print></vessel-print>
                            </section-content>
                            <section-content name="file">
                                <promise-fileup></promise-fileup>
                            </section-content>
                        </panel-seleted>
                        <!-- vesse -->

                        <panel-seleted-vessel>
                            <section-content name="print">
                              <!-- {{shipMent}}//[[dataSelect.shm_id]] -->
                              <iron-pages selected="{{layerContent}}" attr-for-selected="name">
                                <vessel-page on-vessel-edit-common="vesselEditCommon"
                                             on-vessel-insert-common="vesselInsertCommon"
                                             name="third"
                                             data="{{shipMent}}"
                                             shm-id="[[dataSelect.shm_id]]"
                                             contract-id="[[contractId]]" ></vessel-page>
                              <shipment-insert name="thirdHalf" contract-id="[[contractId]]" ></shipment-insert>
                                </iron-pages>
                            </section-content>

                            <section-content name="file">
                                <promise-fileup></promise-fileup>
                            </section-content>
                        </panel-seleted-vessel>
                        <!-- vesse -->
                    </iron-pages>
                </div>
                </template>
            </panel>

            </content-panel>

    </template>
    <script>
        Polymer({
            is: "g2g-add-contract",
            listeners: {
                'nx-grid-tap': 'nxGridTap',
                // 'nx-grid-dblclick': 'nxGridDblclick'
            },
            behaviors: [
                gl.behavior.core,
                gl.behavior.locales
            ],
            properties: {
                layerContent: {
                    type: String,
                    value: "primary"
                },
                vesselPage: {
                    type: Number,
                    value: 0
                },
                idData: {
                    type:String,
                    value:''
                },
                common:{
                  type:Object,
                  value:{}
                },
                bmc:{
                  type:Object,
                  value:{}
                }
            },
            observers:[
              // 'getPortCountry(contractId)'
            ],
            created: function() {
                this.glSetTitle('ทำสัญญา');
                this.glSetLayout('layout-main');
                this.glQuery('addContract',this);
            },
            ready: function() {
              // console.log(this.loaded);
              // list county
              this.getChange(false,'get');
              // list riceType
              this.getDb('./common/typeRice',(data)=>{
                this.typeRice=data;
              },false);
              // list package
              this.getDb('./common/package',(data)=>{
                this.package=data;
              },false);
              this.getDb('./common/seller',(data)=>{
                  this.common.seller= data;
                  // console.log(this.common.seller);
              },false);
              this.getDb('./common/carrier',(data)=>{
                //เอาข้อมูลไปยัดลง item ใน คอมโบบล็อก id carrier_id
                  this.common.carrier= data;
              },false);
              //shipline_id
              this.getDb('./common/shipline/',(data)=>{
                this.common.shipline = data;
              },false);
              //ship in shipline
              this.getDb('./common/shipline/ship',(data)=>{
                this.common.shipInShipline = data;
              },false);
              //get surveyor_id
              this.getDb('./common/surveyor',(data)=>{
                this.common.surveyor = data;
              },false);
              // list port
              this.getDb('./common/port/',(data)=>{
                this.common.countryport =  data;

              },false);
              // list incoterms  ชนิดการจ่าย
              this.getDb('./common/incoterms',(data)=>{
                this.incoterms=data;
              },false);
            },
            getChange:function (refresh,action) {
              console.log('action ',action);
              this.getDb('./g2g/contract/list',(data)=>{
                this.lastResponse=data;
              },refresh,action)
            },
            test:function () {
              console.log('เข้าโวยยยยยยยยยย');
            },
            vesselEditCommon:function (e) {
              // console.log(e.detail.node);

              e.detail.node.common=this.common;
            },
            vesselInsertCommon:function (e) {
              // console.log(e.detail.node);
              e.detail.node.common=this.common;
            },
            confirmMationCommon:function (e) {
              // console.log(e.detail.node);

              e.detail.node.common=this.confirmLetter;
            },
            nxGridTap: function(e) {
                this.layerContent = e.detail.level;
                // console.log(this.layerContent);
                if (this.layerContent === 'third' || this.layerContent === 'thirdHalf' ) {
                    this.vesselPage = 1;
                } else {
                    this.vesselPage = 0;
                }
                this.dataSelect = e.detail.data;
                // console.log(this.dataSelect);
                // this.buyerMasksAndCountry(this.dataSelect.contract_id);
                if (typeof this.dataSelect == 'undefined') {
                  // console.log(1);
                }else {
                  if(this.dataSelect.buyer_id ){
                    this.idData = this.dataSelect.buyer_id;
                    // console.log(this.idData);
                    // console.log(2);
                  }else if (this.dataSelect.shm_id == null ){
                    // this.idData = e.detail.data.cl_id;
                    // console.log(3);
                    this.conFirmDeatil(this.dataSelect.cl_id);
                  }else if (this.dataSelect.shm_id) {
                      //เช็คว่าส่งค่า shm_id มาไหม
                      // console.log(321);
                    // console.log(this.dataSelect.shm_id);
                    this.shipMentDeatil(this.dataSelect.shm_id,true,'get');
                  }
                }
            },
            shipMentDeatil:function (id,refresh,action) {
              // get put delete
              // console.log(action);
              if (action == 'get') {
                this.glQuery('layoutMain').openToastLoading();
              }
              //
              this.getDb('./g2g/shipment/id/'+id,(data)=>{
                this.getDb('./g2g/contract/id/'+data.contract_id,(data2)=>{
                  data.country =  data2.country_id;
                  data.buyerMasks =  data2.buyer_masks;
                  this.shipMent = data;
                },refresh,action);
              });
            },
            getconfirm:function (contractId) {
                this.getDb('./g2g/confirm/contract/id/'+contractId,(data)=>{
                  this.cml = data;
                  // console.log(this.cml);
                  // this.cl_id.items = data;
                });
            },
            conFirmDeatil:function (cmlId) {
              this.glQuery('layoutMain').openToastLoading();
              this.getDb('./g2g/confirm/id/'+cmlId,(data)=>{
                this.confirmLetter = data;
                // console.log(this.confirmLetter);
              },true,'get');
            },
            nxGridDblclick: function(e) {
                // if (e.detail.level == 'primary') {
                // this.glChangePath('/gtog/add-period');
                //this.layoutMain.changePath('/gtog/add-period');
                // }
            },
            getDb:function (url,callback,refresh,action) {
              // console.log(url);
              axios.get(url)
                .then(function(response){
                    callback(response.data);
                    // console.log(action);
                      switch (action) {
                          case 'get':
                                    this.glQuery('layoutMain').closeToastLoading(function(){
                                      // if (refresh == true) {
                                      //   this.glQuery('contentPanel').changDrawer();
                                      // }
                                      this.checkRefresh(refresh);
                                    }.bind(this));
                          break;
                          // insert & updoate
                          case 'put':
                                    this.glQuery('layoutMain').closeToastSaveing(function(){
                                      // if (refresh == true) {
                                      //   this.glQuery('contentPanel').changDrawer();
                                      // }
                                      this.checkRefresh(refresh);
                                    }.bind(this));
                          break;
                          case 'delete':
                                    this.glQuery('layoutMain').closeToastDeleteing(function(){
                                      // if (refresh == true) {
                                      //   this.glQuery('contentPanel').changDrawer();
                                      // }
                                      this.checkRefresh(refresh);
                                    }.bind(this));
                          break;

                      }


                }.bind(this))
                .catch(function (error) {
                }.bind(this));
                // console.log(1);
            },
            checkRefresh:function (refresh) {
              if (refresh == true) {
                this.glQuery('contentPanel').changDrawer();
              }
            },
            attached:function(){
              this.layoutMain = this.glQuery('layoutMain');

              var resolvedPageUrl = this.resolveUrl(`components/promise/promise-insert.html`);
              this.importHref(resolvedPageUrl,null,null,true);

              var resolvedPageUrl = this.resolveUrl(`components/promise/promise-confirm.html`);
              this.importHref(resolvedPageUrl,null,null,true);

              var resolvedPageUrl = this.resolveUrl(`components/promise/promise-detail.html`);
              this.importHref(resolvedPageUrl,null,null,true);

              var resolvedPageUrl = this.resolveUrl(`components/promise/promise-fileup.html`);
              this.importHref(resolvedPageUrl,null,null,true);

              var resolvedPageUrl = this.resolveUrl(`components/vessel/vessel-print.html`);
              this.importHref(resolvedPageUrl,null,null,true);

              var resolvedPageUrl = this.resolveUrl(`components/vessel/vessel-page.html`);
              this.importHref(resolvedPageUrl,null,null,true);

              this.async(()=>{this.loaded = true;},1000);

            },

        });;
    </script>
</dom-module>
