<dom-module id="db-gtog-contact">
    <script>
    Polymer({
      is:'db-gtog-contact',
      behaviors: [
        gl.behavior.core
      ],
      created:function(){
         
        this.connectDb();

        // this.fetchOverviewList((data)=>{
        //     console.log(data);
        // });

        // this.fetchContract2('contract1',(data)=>{
        //     console.log(data);
        // });

        // this.fetchContract('contract1',(data)=>{
        //     console.log(data);
        // });

        // this.fetchConfirmation('confirmation1',(data)=>{
        //     console.log(data);
        // });

        // this.fetchRice(['rice1','rice2'],(data)=>{
        //     console.log(data);
        // })
            
      },
      connectDb:function(){
          this.db = new PouchDB('http://127.0.0.1:5984/gtog');
      },
      fetchOverviewList:function(callback){

            this.db.get('_design/contract').then((view)=>{
                return view;
            }).then((view)=>{
                return this.db.query(view.views['overviewList'], {
                    include_docs : true
                })
            }).then((data)=>{
                let result = {data:[],index:[],stack:[]};
                data.rows.map((row)=>{
                    let type = row.doc.type;
                    if(type == 'contract'){

                        result.data.push(row.doc);
                        result.index.push(row.doc._id);

                        let index = result.data.length-1;
                        result.data[index]['confirmation'] = [];
                        result.data[index]['period'] = [];

                    }else if(type == 'confirmation'){
                        
                        let index = result.index.indexOf(row.doc.contractId);
                        result.data[index].confirmation.push(row.doc);

                    }else if(type == 'period'){
                        let index = result.index.indexOf(row.doc.contractId);
                        result.data[index].period.push(row.doc);
                        
                    }

                });

                callback(result.data);
                
            });

      },
    

      fetchContract:function(contractId,callback){
            this.db.get(contractId).then((view)=>{
                return view;
            }).then((view)=>{
                callback(view);
            });
      },

      fetchContract2:function(contractId,callback){
            this.db.get('_design/contract').then((view)=>{
                return view;
            }).then((view)=>{
                return this.db.query(view.views['contract'], {
                    startkey: [contractId],
                    endkey: [contractId,{}],
                    include_docs : true
                })
            }).then((data)=>{
                let result = {data:[],index:[],stack:[]};
                data.rows.map((row)=>{
                    let type = row.doc.type;
                    if(type == 'contract'){
                        result.data.push(row.doc);
                        result.index.push(row.doc._id);
                    }else if(type == 'rice'){
                        let index = result.index.indexOf(row.id);
                        result.data[index].rice.map((res,i)=>{
                            if(row.doc._id==res.riceId){
                                result.data[index].rice[i]['name'] = row.doc.name;
                            }
                        });
                    }

                });

                callback(result.data);
            });
      },

      

      fetchConfirmation:function(confirmationId,callback){
            this.db.get(confirmationId).then((view)=>{
                return view;
            }).then((view)=>{
                callback(view);
            });
      },

      fetchRice:function(arrRiceId,callback){
            var all = (arrRiceId==null);
            this.db.get('_design/rice').then((view)=>{
                return view;
            }).then((view)=>{
                if(all){
                    return this.db.query(view.views['rice']);
                }else{
                    return this.db.query(view.views['rice'], {
                        keys: arrRiceId
                    });
                }
                
            }).then((data)=>{
                callback(data);
            });
      }


      

    });
  </script>
</dom-module>